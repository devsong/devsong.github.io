<!DOCTYPE html> <html lang="en"> <head> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title>使用innodb_space命令查看段(segment)、区(extent)、页(page)以及索引信息 | devsong's website</title> <meta name="author" content="guan zhisong"/> <meta name="description" content="记录日常学习的代码、问题以及个人对相关技术的一些思考与见解 "/> <meta name="keywords" content="jekyll, jekyll-theme, academic-website, portfolio-website"/> <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha256-DF7Zhf293AJxJNTmh5zhoYYIMs2oXitRfBjY+9L//AY=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"/> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/academicons@1.9.1/css/academicons.min.css" integrity="sha256-i1+4qU2G2860dGGIOJscdC30s9beBXjFfzjWLjBRsBg=" crossorigin="anonymous"> <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/github.css" media="" id="highlight_theme_light"/> <link rel="shortcut icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>⚛️</text></svg>"> <link rel="stylesheet" href="/assets/css/main.css"> <link rel="canonical" href="https://devsong.github.io/blog/2021/06/006-innodb_space%E5%91%BD%E4%BB%A4%E6%9F%A5%E7%9C%8B%E6%AE%B5(Segment)-%E5%8C%BA(extent)-%E9%A1%B5(page)%E4%BB%A5%E5%8F%8A%E7%B4%A2%E5%BC%95%E4%BF%A1%E6%81%AF/"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/native.css" media="none" id="highlight_theme_dark"/> <script src="/assets/js/theme.js"></script> <script src="/assets/js/dark_mode.js"></script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/">devsong's website</a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">关于</a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">博客<span class="sr-only">(current)</span></a> </li> <li class="nav-item "> <a class="nav-link" href="/repositories/">github</a> </li> <li class="nav-item "> <a class="nav-link" href="/cv/">个人简介</a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="fas fa-moon"></i> <i class="fas fa-sun"></i> </button> </li> </ul> </div> </div> </nav> </header> <div class="container mt-5"> <div class="post"> <header class="post-header"> <h1 class="post-title">使用innodb_space命令查看段(segment)、区(extent)、页(page)以及索引信息</h1> <p class="post-meta">June 5, 2021</p> <p class="post-tags"> <a href="/blog/2021"> <i class="fas fa-calendar fa-sm"></i> 2021 </a>   ·   <a href="/blog/tag/blogs"> <i class="fas fa-hashtag fa-sm"></i> blogs</a>   <a href="/blog/tag/mysql"> <i class="fas fa-hashtag fa-sm"></i> mysql</a>   <a href="/blog/tag/innodb"> <i class="fas fa-hashtag fa-sm"></i> innodb</a>   <a href="/blog/tag/segment"> <i class="fas fa-hashtag fa-sm"></i> segment</a>   <a href="/blog/tag/extent"> <i class="fas fa-hashtag fa-sm"></i> extent</a>   <a href="/blog/tag/page"> <i class="fas fa-hashtag fa-sm"></i> page</a>     ·   <a href="/blog/category/blogs"> <i class="fas fa-tag fa-sm"></i> blogs</a>   </p> </header> <article class="post-content"> <h3 id="使用innodb_space命令查看段segment区extent页page以及索引信息">使用innodb_space命令查看段(segment)、区(extent)、页(page)以及索引信息</h3> <p>前面我们介绍完枯燥的表空间、段、区数据结构后,现在我们来看看实战,以一个200w+的数据表user_info2为例,结合工具innodb_space来分析具体的数据表结构,innodb_space的安装具体可以参见<a href="/blog/2021/06/004-innodb_space%E5%B7%A5%E5%85%B7%E4%BD%BF%E7%94%A8/">innodb_space工具使用</a></p> <p>两个变量:</p> <ul> <li>MYSQL_BASE_DIR 指代mysql的安装目录</li> <li>MYSQL_DATA_DIR 指代mysql的数据目录</li> </ul> <p>执行<code class="language-plaintext highlighter-rouge">cd $MYSQL_DATA_DIR</code> 进入mysql数据存放目录,在我本机此目录为 <code class="language-plaintext highlighter-rouge">/usr/local/var/mysql</code>,后续所有innodb_space的命令的执行均在此目录下</p> <p>user_info2数据表的数据量:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
</pre></td> <td class="rouge-code"><pre>select count(1) from user_info2;
</pre></td> </tr></tbody></table></code></pre></div></div> <p>输出:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td> <td class="rouge-code"><pre>+----------+
| count(1) |
+----------+
|  2300000 |
+----------+
</pre></td> </tr></tbody></table></code></pre></div></div> <p>test数据库目录下文件结构:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td> <td class="rouge-code"><pre>-rw-r-----  1 staff  admin    67B May 13 19:49 db.opt
-rw-r-----  1 staff  admin    21K Jun  3 17:07 test_fsp.frm
-rw-r-----  1 staff  admin   784K Jun  3 17:07 test_fsp.ibd
-rw-r-----  1 staff  admin   8.6K May 24 19:46 user_info.frm
-rw-r-----  1 staff  admin   112K Jun  4 10:10 user_info.ibd
-rw-r-----  1 staff  admin   8.6K May 25 16:03 user_info2.frm
-rw-r-----  1 staff  admin   344M Jun  3 15:12 user_info2.ibd
</pre></td> </tr></tbody></table></code></pre></div></div> <h4 id="查看表空间文件数据页数量分布的百分比">查看表空间文件数据页数量、分布的百分比</h4> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
</pre></td> <td class="rouge-code"><pre>innodb_space -s /usr/local/var/mysql/ibdata1 -T test/user_info2 space-page-type-summary
</pre></td> </tr></tbody></table></code></pre></div></div> <p>输出</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td> <td class="rouge-code"><pre>type                count       percent     description
INDEX               20377       92.56       B+Tree index
ALLOCATED           1634        7.42        Freshly allocated
IBUF_BITMAP         2           0.01        Insert buffer bitmap
FSP_HDR             1           0.00        File space header
INODE               1           0.00        File segment inode
XDES                1           0.00        Extent descriptor
</pre></td> </tr></tbody></table></code></pre></div></div> <p>可以看到当前user_info2总共有20377个数据(索引)页，占比92%,新申请的空闲空间数据页占比7%,元数据信息页总的占比不足1%</p> <h4 id="查看表空间的索引信息">查看表空间的索引信息</h4> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
</pre></td> <td class="rouge-code"><pre>innodb_space -s /usr/local/var/mysql/ibdata1 -T test/user_info2 space-indexes
</pre></td> </tr></tbody></table></code></pre></div></div> <p>输出</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td> <td class="rouge-code"><pre>id          name                            root        fseg        fseg_id     used        allocated   fill_factor
51          PRIMARY                         3           internal    1           17          17          100.00%
51          PRIMARY                         3           leaf        2           13530       13536       99.96%
52          idx_phone                       4           internal    3           16          16          100.00%
52          idx_phone                       4           leaf        4           4850        6237        77.76%
</pre></td> </tr></tbody></table></code></pre></div></div> <p>root为索引的根节点数据页,fseg为类型(internal代表非页节点,leaf代表页节点)fseg_id为段ID</p> <h4 id="查看表空间每个段的基本信息">查看表空间每个段的基本信息</h4> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
</pre></td> <td class="rouge-code"><pre>innodb_space -s /usr/local/var/mysql/ibdata1 -T test/user_info2 space-inodes-summary
</pre></td> </tr></tbody></table></code></pre></div></div> <p>输出</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td> <td class="rouge-code"><pre>INODE fseg_id=1, pages=17, frag=17, full=0, not_full=0, free=0
INODE fseg_id=2, pages=13536, frag=32, full=210, not_full=1, free=0
INODE fseg_id=3, pages=16, frag=16, full=0, not_full=0, free=0
INODE fseg_id=4, pages=6237, frag=29, full=28, not_full=69, free=0
</pre></td> </tr></tbody></table></code></pre></div></div> <ul> <li>fseg_id=1参照上述PRIMARY索引节点信息,fseg_id=1代表主索引的非页节点,一共使用了17个碎片页</li> <li>fseg_id=2代表<strong>PRIMARY</strong>的数据(叶子)节点,真实的数据存放于这些页面,一共13536个数据页</li> <li>fseg_id为3和4的代表的是辅助索引<strong>idx_phone</strong>的描述信息,与PRIMARY索引类似,此处不再赘述</li> </ul> <h4 id="查看inodes各个段区具体的描述信息">查看inodes各个段、区具体的描述信息</h4> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
</pre></td> <td class="rouge-code"><pre>innodb_space -s /usr/local/var/mysql/ibdata1 -T test/user_info2 space-inodes-detail
</pre></td> </tr></tbody></table></code></pre></div></div> <p>输出</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td> <td class="rouge-code"><pre>INODE fseg_id=1, pages=17, frag=17 pages (3, 133, 134, 135, 138, 141, 142, 143, 145, 149, 150, 151, 152, 154, 156, 161, 165), full=0 extents (), not_full=0 extents () (0/0 pages used), free=0 extents ()
INODE fseg_id=2, pages=13536, frag=32 pages (5, 6, 7, 8, 9, 12, 13, 14, 16, 18, 19, 20, 21, 22, 23, 27, 28, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 43, 44, 47, 50), full=210 extents (64-127, 192-255, 320-383, 384-447, 512-575, 576-639, 640-703, 832-895, 896-959, 1024-1087, 1088-1151, 1152-1215, 1216-1279, 1344-1407, 1472-1535, 1600-1663, 1664-1727, 1728-1791, 1856-1919, 1920-1983, 1984-2047, 2048-2111, 2112-2175, 2176-2239, 2304-2367, 2368-2431, 2496-2559, 2624-2687, 2752-2815, 2880-2943, 3008-3071, 3072-3135, 3200-3263, 3328-3391, 3392-3455, 3456-3519, 3584-3647, 3648-3711, 3712-3775, 3776-3839, 3840-3903, 3904-3967, 3968-4031, 4032-4095, 4096-4159, 4224-4287, 4288-4351, 4352-4415, 4416-4479, 4544-4607, 4608-4671, 4736-4799, 4800-4863, 4928-4991, 5056-5119, 5184-5247, 5312-5375, 5440-5503, 5568-5631, 5696-5759, 5824-5887, 5952-6015, 6016-6079, 6144-6207, 6272-6335, 6336-6399, 6464-6527, 6528-6591, 6592-6655, 6720-6783, 6784-6847, 6848-6911, 6976-7039, 7040-7103, 7104-7167, 7232-7295, 7296-7359, 7360-7423, 7424-7487, 7488-7551, 7552-7615, 7616-7679, 7680-7743, 7808-7871, 7872-7935, 7936-7999, 8000-8063, 8064-8127, 8128-8191, 8192-8255, 8256-8319, 8320-8383, 8448-8511, 8512-8575, 8576-8639, 8640-8703, 8768-8831, 8832-8895, 8896-8959, 9024-9087, 9088-9151, 9216-9279, 9280-9343, 9408-9471, 9536-9599, 9664-9727, 9728-9791, 9856-9919, 9984-10047, 10112-10175, 10240-10303, 10368-10431, 10496-10559, 10624-10687, 10752-10815, 10880-10943, 11008-11071, 11072-11135, 11200-11263, 11328-11391, 11456-11519, 11584-11647, 11648-11711, 11776-11839, 11904-11967, 11968-12031, 12096-12159, 12160-12223, 12288-12351, 12416-12479, 12480-12543, 12608-12671, 12736-12799, 12800-12863, 12864-12927, 12992-13055, 13056-13119, 13120-13183, 13248-13311, 13312-13375, 13440-13503, 13504-13567, 13568-13631, 13696-13759, 13760-13823, 13824-13887, 13952-14015, 14016-14079, 14080-14143, 14144-14207, 14272-14335, 14336-14399, 14400-14463, 14464-14527, 14592-14655, 14656-14719, 14720-14783, 14784-14847, 14848-14911, 14912-14975, 14976-15039, 15104-15167, 15168-15231, 15232-15295, 15296-15359, 15360-15423, 15424-15487, 15488-15551, 15552-15615, 15616-15679, 15680-15743, 15808-15871, 15872-15935, 15936-15999, 16000-16063, 16064-16127, 16128-16191, 16192-16255, 16256-16319, 16448-16511, 16512-16575, 16576-16639, 16640-16703, 16704-16767, 16832-16895, 16896-16959, 16960-17023, 17024-17087, 17152-17215, 17216-17279, 17280-17343, 17408-17471, 17472-17535, 17536-17599, 17664-17727, 17728-17791, 17792-17855, 17920-17983, 17984-18047, 18112-18175, 18176-18239, 18304-18367, 18368-18431, 18496-18559, 18560-18623, 18688-18751, 18752-18815, 18880-18943, 19008-19071, 19136-19199), not_full=1 extents (19200-19263) (58/64 pages used), free=0 extents ()
INODE fseg_id=3, pages=16, frag=16 pages (4, 136, 137, 139, 140, 144, 146, 147, 148, 155, 157, 158, 159, 160, 162, 163), full=0 extents (), not_full=0 extents () (0/0 pages used), free=0 extents ()
INODE fseg_id=4, pages=6237, frag=29 pages (10, 11, 15, 17, 24, 25, 26, 29, 41, 42, 45, 46, 49, 51, 52, 53, 54, 55, 56, 57, 58, 60, 61, 62, 128, 129, 130, 131, 132), full=28 extents (1408-1471, 2944-3007, 3136-3199, 5632-5695, 5760-5823, 5888-5951, 6080-6143, 6208-6271, 10432-10495, 10560-10623, 10688-10751, 10816-10879, 10944-11007, 11136-11199, 11264-11327, 11392-11455, 11520-11583, 11712-11775, 11840-11903, 12032-12095, 12224-12287, 12352-12415, 12544-12607, 12672-12735, 12928-12991, 13184-13247, 13376-13439, 13632-13695), not_full=69 extents (19392-19455, 19520-19583, 19840-19903, 19968-20031, 20160-20223, 20608-20671, 20800-20863, 20928-20991, 21248-21311, 19264-19327, 9472-9535, 10176-10239, 18816-18879, 18432-18495, 18624-18687, 17856-17919, 19072-19135, 4672-4735, 8704-8767, 1792-1855, 5248-5311, 9152-9215, 18944-19007, 17344-17407, 4480-4543, 4864-4927, 17600-17663, 9792-9855, 704-767, 448-511, 16768-16831, 2240-2303, 18240-18303, 960-1023, 18048-18111, 4160-4223, 4992-5055, 17088-17151, 2432-2495, 16320-16383, 256-319, 7168-7231, 10048-10111, 1280-1343, 9600-9663, 768-831, 8384-8447, 8960-9023, 15744-15807, 6912-6975, 7744-7807, 5120-5183, 14208-14271, 3264-3327, 2816-2879, 1536-1599, 2560-2623, 14528-14591, 15040-15103, 3520-3583, 9344-9407, 9920-9983, 10304-10367, 5504-5567, 2688-2751, 13888-13951, 6656-6719, 5376-5439, 6400-6463) (3029/4416 pages used), free=0 extents ()
</pre></td> </tr></tbody></table></code></pre></div></div> <p>此处通过双向链表遍历了具体的数据元信息,给出了每一个段里面的区(编号)、碎片页信息，以fseg_id=2的数据节点说明</p> <ul> <li>frag=32 pages (5, 6, 7, 8,….）此处省略了一部分碎片页,代表当前段一共使用的32个数据页以及具体数据页的编号</li> <li>full=210 extents (64-127, 192-255, 320-383,….)代表当前使用的full区的个数以及具体的区的编号(区的编号以起始-结束数据页的方式给出)</li> <li>not_full=1 extents (19200-19263) (58/64 pages used), 代表当前未完全填满的区的位置</li> <li>free=0 extents () 空闲区的位置</li> </ul> <h4 id="查看段对应的索引具体信息">查看段对应的索引具体信息</h4> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
</pre></td> <td class="rouge-code"><pre>innodb_space <span class="nt">-s</span> /usr/local/var/mysql/ibdata1 <span class="nt">-T</span> <span class="nb">test</span>/user_info2 <span class="nt">-F</span> 1 space-index-fseg-pages-summary
</pre></td> </tr></tbody></table></code></pre></div></div> <p>输出:</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td> <td class="rouge-code"><pre>page        index   level   data    free    records
3           51      2       272     15974   16
133         51      1       7888    8132    464
134         51      1       15776   14      928
135         51      1       15776   14      928
138         51      1       15776   14      928
141         51      1       15776   14      928
142         51      1       15776   14      928
143         51      1       15776   14      928
145         51      1       15776   14      928
149         51      1       15776   14      928
150         51      1       15776   14      928
151         51      1       15776   14      928
152         51      1       15776   14      928
154         51      1       15776   14      928
156         51      1       15776   14      928
161         51      1       15776   14      928
165         51      1       1258    14958   74
</pre></td> </tr></tbody></table></code></pre></div></div> <ul> <li>page 页号,ibd文件中的数据页编号</li> <li>index 索引编号,一个索引由2个段(非叶节点段、叶节点段)构成</li> <li>level 索引的层级,叶子节点的level为0,向上生长,越靠近根节点越大,此处page=3,level=2代表根节点,亦即此数据表的B+树索引为3层</li> <li>data 当前数据页使用的空间大小</li> <li>free 当前数据页空闲的空间大小</li> <li>records 当前的数据页数据条数</li> </ul> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
</pre></td> <td class="rouge-code"><pre>innodb_space <span class="nt">-s</span> /usr/local/var/mysql/ibdata1 <span class="nt">-T</span> <span class="nb">test</span>/user_info2 <span class="nt">-F</span> 2 space-index-fseg-pages-summary | more
</pre></td> </tr></tbody></table></code></pre></div></div> <p>输出</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td> <td class="rouge-code"><pre>page        index   level   data    free    records
5           51      0       7565    8645    85
6           51      0       15130   1040    170
7           51      0       15130   1040    170
8           51      0       15130   1040    170
9           51      0       15130   1040    170
12          51      0       15130   1040    170
13          51      0       15130   1040    170
14          51      0       15130   1040    170
16          51      0       15130   1040    170
18          51      0       15130   1040    170
19          51      0       15130   1040    170
20          51      0       15130   1040    170
21          51      0       15130   1040    170
22          51      0       15130   1040    170
</pre></td> </tr></tbody></table></code></pre></div></div> <p>此处<code class="language-plaintext highlighter-rouge">more</code>只显示了部分数据,可以看到,非叶子节点一页的数据条目数载928左右,叶子节点数据条目数在170左右,据此可以粗略测算一棵深度为2和3的数据量以及对应的文件大小</p> <ul> <li>深度为2(2层)的B+树 <ul> <li>数据量:928*170 = 157760,数据量规模在15w+</li> <li>数据文件大小(只有一个主索引的case):(928+1)*16kb/1024 = 14M左右</li> </ul> </li> <li>深度为3(3层)的B+树 <ul> <li>数据量:928*928*170 = 146401280,数据量规模在1.4亿</li> <li>数据文件大小：(928*928+928+1)*16kb/(1024*1024) = 13GB左右</li> </ul> </li> </ul> <p>此处的估算均为粗略的估算,最终的结果还跟表中的数据行的平均大小(字段多少)相关,上例中表的字段个数为6个,每行的字节数平均在89(15130/170 = 89)左右，对于其他类型的数据表,各位可以自己根据实际的表结构自行进行换算后计算</p> <h4 id="谈到了索引此处可以进一步来看一下mysql整体的索引结构">谈到了索引,此处可以进一步来看一下Mysql整体的索引结构</h4> <p><img src="/assets/img/mysql/innodb/btree_arch.jpeg" width="760" alt="btree_arch.jpeg"></p> <p>一个典型的3层索引结构,数据查询从根节点开始,逐级往下层查找,找到记录对应的叶子节点后,将对应的叶子节点load进内存后进一步进行页内查找,说明一下索引查找只能定位到数据页,并不能定位到具体的数据条目，因此mysql的数据查找过程实际上是由两部分的构成</p> <ul> <li> <p>位于磁盘的索引数据页(磁盘IO,对于单个主键类型的id查询,通常是2-3次)查找</p> </li> <li> <p>位于内存的具体的数据页(内存)查找,只不过由于内存的速度较磁盘的速度快很多(具体参见<a href="https://devsong.github.io/p/14831588.html">存储体系</a>一文介绍)，此部分的开销通常可以忽略不计,因此我们的数据查询开销花费都集中在上述磁盘IO部分,亦即索引查找部分</p> </li> </ul> <p>可以参见下图红色部分以查找key=3的记录的过程 <img src="/assets/img/mysql/innodb/btree_arch_red.jpeg" width="760" alt="btree_arch_red.jpeg"></p> <p>以user_info2表为例,我们来看下主索引的数据页结构,<code class="language-plaintext highlighter-rouge">-I</code> 参数后接索引名,<code class="language-plaintext highlighter-rouge">-l</code> 参数后接索引层级</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
</pre></td> <td class="rouge-code"><pre>innodb_space -s /usr/local/var/mysql/ibdata1 -T test/user_info2 index-level-summary -I PRIMARY -l 2
</pre></td> </tr></tbody></table></code></pre></div></div> <p>根节点输出:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td> <td class="rouge-code"><pre>page    index   level   data    free    records min_key
3       51      2       272     15974   16      id=1
</pre></td> </tr></tbody></table></code></pre></div></div> <p>根节点具体的key的目录槽(具体目录槽的内容可以参见数据页格式分析一章)</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
</pre></td> <td class="rouge-code"><pre>innodb_space -s /usr/local/var/mysql/ibdata1 -T test/user_info2 -p 3 page-directory-summary
</pre></td> </tr></tbody></table></code></pre></div></div> <p>输出</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td> <td class="rouge-code"><pre>slot    offset  type          owned   key
0       99      infimum       1
1       176     node_pointer  4       (id=394316)
2       244     node_pointer  4       (id=1025356)
3       312     node_pointer  4       (id=1656396)
4       112     supremum      5
</pre></td> </tr></tbody></table></code></pre></div></div> <ul> <li>slot: 页数据槽索引</li> <li>offset: 数据槽对应的页内偏移位置</li> <li>type:数据槽类型,infimum/supremum代表最大最小值,系统添加,node_pointer索引节点类型，指向下一层节点</li> <li>owned: 代表当前槽与临接槽之间的数据节点个数(实际上page_dir_slot是一个稀疏目录)</li> <li>key:当前槽的节点Key值</li> </ul> <p>可以看到根节点数据页page_slot槽目前有三个(抛开infimum根supremum两个记录，这俩记录是系统记录,代表当前页的最小、最大值,后续介绍页结构会说明),key值即是主键ID的数值</p> <p>再来看看level=1的数据页节点</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
</pre></td> <td class="rouge-code"><pre>innodb_space <span class="nt">-s</span> /usr/local/var/mysql/ibdata1 <span class="nt">-T</span> <span class="nb">test</span>/user_info2 index-level-summary <span class="nt">-I</span> PRIMARY <span class="nt">-l</span> 1
</pre></td> </tr></tbody></table></code></pre></div></div> <p>输出:</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td> <td class="rouge-code"><pre>page   index   level   data    free    records min_key
133     51      1       7888    8132    464     <span class="nb">id</span><span class="o">=</span>1
134     51      1       15776   14      928     <span class="nb">id</span><span class="o">=</span>78796
135     51      1       15776   14      928     <span class="nb">id</span><span class="o">=</span>236556
138     51      1       15776   14      928     <span class="nb">id</span><span class="o">=</span>394316
141     51      1       15776   14      928     <span class="nb">id</span><span class="o">=</span>552076
142     51      1       15776   14      928     <span class="nb">id</span><span class="o">=</span>709836
143     51      1       15776   14      928     <span class="nb">id</span><span class="o">=</span>867596
145     51      1       15776   14      928     <span class="nb">id</span><span class="o">=</span>1025356
149     51      1       15776   14      928     <span class="nb">id</span><span class="o">=</span>1183116
150     51      1       15776   14      928     <span class="nb">id</span><span class="o">=</span>1340876
151     51      1       15776   14      928     <span class="nb">id</span><span class="o">=</span>1498636
152     51      1       15776   14      928     <span class="nb">id</span><span class="o">=</span>1656396
154     51      1       15776   14      928     <span class="nb">id</span><span class="o">=</span>1814156
156     51      1       15776   14      928     <span class="nb">id</span><span class="o">=</span>1971916
161     51      1       15776   14      928     <span class="nb">id</span><span class="o">=</span>2129676
165     51      1       1258    14958   74      <span class="nb">id</span><span class="o">=</span>2287436
</pre></td> </tr></tbody></table></code></pre></div></div> <p>以数据页133为例,我们可以看看133数据页的slots目录数据内容</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
</pre></td> <td class="rouge-code"><pre>innodb_space <span class="nt">-s</span> /usr/local/var/mysql/ibdata1 <span class="nt">-T</span> <span class="nb">test</span>/user_info2 <span class="nt">-p</span> 133 page-directory-summary | more
</pre></td> </tr></tbody></table></code></pre></div></div> <p>输出(此处只列出了部分数据页):</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td> <td class="rouge-code"><pre>slot    offset  <span class="nb">type          </span>owned   key
0       99      infimum       1
1       176     node_pointer  4       <span class="o">(</span><span class="nb">id</span><span class="o">=</span>426<span class="o">)</span>
2       244     node_pointer  4       <span class="o">(</span><span class="nb">id</span><span class="o">=</span>1106<span class="o">)</span>
3       312     node_pointer  4       <span class="o">(</span><span class="nb">id</span><span class="o">=</span>1786<span class="o">)</span>
4       380     node_pointer  4       <span class="o">(</span><span class="nb">id</span><span class="o">=</span>2466<span class="o">)</span>
5       448     node_pointer  4       <span class="o">(</span><span class="nb">id</span><span class="o">=</span>3146<span class="o">)</span>
6       516     node_pointer  4       <span class="o">(</span><span class="nb">id</span><span class="o">=</span>3826<span class="o">)</span>
7       584     node_pointer  4       <span class="o">(</span><span class="nb">id</span><span class="o">=</span>4506<span class="o">)</span>
8       652     node_pointer  4       <span class="o">(</span><span class="nb">id</span><span class="o">=</span>5186<span class="o">)</span>
9       720     node_pointer  4       <span class="o">(</span><span class="nb">id</span><span class="o">=</span>5866<span class="o">)</span>
10      788     node_pointer  4       <span class="o">(</span><span class="nb">id</span><span class="o">=</span>6546<span class="o">)</span>
11      856     node_pointer  4       <span class="o">(</span><span class="nb">id</span><span class="o">=</span>7226<span class="o">)</span>
12      924     node_pointer  4       <span class="o">(</span><span class="nb">id</span><span class="o">=</span>7906<span class="o">)</span>
13      992     node_pointer  4       <span class="o">(</span><span class="nb">id</span><span class="o">=</span>8586<span class="o">)</span>
14      1060    node_pointer  4       <span class="o">(</span><span class="nb">id</span><span class="o">=</span>9266<span class="o">)</span>
15      1128    node_pointer  4       <span class="o">(</span><span class="nb">id</span><span class="o">=</span>9946<span class="o">)</span>
</pre></td> </tr></tbody></table></code></pre></div></div> <p>查看node_pointer指向的下层数据页(dump数据页内容)</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
</pre></td> <td class="rouge-code"><pre>innodb_space <span class="nt">-s</span> /usr/local/var/mysql/ibdata1 <span class="nt">-T</span> <span class="nb">test</span>/user_info2 <span class="nt">-p</span> 133 page-records | more
</pre></td> </tr></tbody></table></code></pre></div></div> <p>输出:</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td> <td class="rouge-code"><pre>Record 125: <span class="o">(</span><span class="nb">id</span><span class="o">=</span>1<span class="o">)</span> → <span class="c">#5</span>
Record 142: <span class="o">(</span><span class="nb">id</span><span class="o">=</span>86<span class="o">)</span> → <span class="c">#6</span>
Record 159: <span class="o">(</span><span class="nb">id</span><span class="o">=</span>256<span class="o">)</span> → <span class="c">#7</span>
Record 176: <span class="o">(</span><span class="nb">id</span><span class="o">=</span>426<span class="o">)</span> → <span class="c">#8</span>
Record 193: <span class="o">(</span><span class="nb">id</span><span class="o">=</span>596<span class="o">)</span> → <span class="c">#9</span>
Record 210: <span class="o">(</span><span class="nb">id</span><span class="o">=</span>766<span class="o">)</span> → <span class="c">#12</span>
Record 227: <span class="o">(</span><span class="nb">id</span><span class="o">=</span>936<span class="o">)</span> → <span class="c">#13</span>
Record 244: <span class="o">(</span><span class="nb">id</span><span class="o">=</span>1106<span class="o">)</span> → <span class="c">#14</span>
Record 261: <span class="o">(</span><span class="nb">id</span><span class="o">=</span>1276<span class="o">)</span> → <span class="c">#16</span>
Record 278: <span class="o">(</span><span class="nb">id</span><span class="o">=</span>1446<span class="o">)</span> → <span class="c">#18</span>
Record 295: <span class="o">(</span><span class="nb">id</span><span class="o">=</span>1616<span class="o">)</span> → <span class="c">#19</span>
Record 312: <span class="o">(</span><span class="nb">id</span><span class="o">=</span>1786<span class="o">)</span> → <span class="c">#20</span>
Record 329: <span class="o">(</span><span class="nb">id</span><span class="o">=</span>1956<span class="o">)</span> → <span class="c">#21</span>
Record 346: <span class="o">(</span><span class="nb">id</span><span class="o">=</span>2126<span class="o">)</span> → <span class="c">#22</span>
</pre></td> </tr></tbody></table></code></pre></div></div> <p>我们来看看一条按照ID查询的sql具体的数据查找过程</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
</pre></td> <td class="rouge-code"><pre><span class="k">select</span> <span class="k">*</span> from user_info2 where <span class="nb">id</span> <span class="o">=</span> 1107
</pre></td> </tr></tbody></table></code></pre></div></div> <p>数据页流向: <strong>PAGE_NO_3</strong>(根节点页)-&gt;<strong>PAGE_NO_133</strong>(level=1的节点页)-&gt;<strong>PAGE_14</strong>,一共三次磁盘IO,实际上Mysql通常会把索引的根节点页常驻内存,亦即根节点的磁盘IO实际上可以省略,总共花费2次磁盘IO即可以定位到数据页</p> </article> </div> <style>table{border-left:1px solid #000;border-top:1px solid #000;width:100%;word-wrap:break-word;word-break:break-all}table th{text-align:left;min-width:60px;max-width:300px}table th,td{border-right:1px solid #000;border-bottom:1px solid #000}</style> </div> <footer class="fixed-bottom"> <div class="container mt-0"> © Copyright 2023 guan zhisong. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="noopener noreferrer">Jekyll</a> with <a href="https://github.com/devsong/devsong.github.io" target="_blank" rel="noopener noreferrer">devsong.github.io</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="noopener noreferrer">GitHub Pages</a>. Photos from <a href="https://unsplash.com" target="_blank" rel="noopener noreferrer">Unsplash</a>. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js" integrity="sha256-fgLAgv7fyCGopR/gBNq2iW3ZKIdqIcyshnUULC4vex8=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script type="text/javascript">$(function(){$('[data-toggle="tooltip"]').tooltip()});</script> <script defer src="/assets/js/common.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> </body> </html>