<!DOCTYPE html> <html lang="en"> <head> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title>散列算法与布隆过滤器 | devsong's website</title> <meta name="author" content="guan zhisong"/> <meta name="description" content="记录日常学习的代码、问题以及个人对相关技术的一些思考与见解 "/> <meta name="keywords" content="jekyll, jekyll-theme, academic-website, portfolio-website"/> <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha256-DF7Zhf293AJxJNTmh5zhoYYIMs2oXitRfBjY+9L//AY=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"/> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/academicons@1.9.1/css/academicons.min.css" integrity="sha256-i1+4qU2G2860dGGIOJscdC30s9beBXjFfzjWLjBRsBg=" crossorigin="anonymous"> <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/github.css" media="" id="highlight_theme_light"/> <link rel="shortcut icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>⚛️</text></svg>"> <link rel="stylesheet" href="/assets/css/main.css"> <link rel="canonical" href="https://devsong.github.io/blog/2022/03/004-%E6%95%A3%E5%88%97%E4%B8%8E%E5%B8%83%E9%9A%86%E8%BF%87%E6%BB%A4%E5%99%A8/"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/native.css" media="none" id="highlight_theme_dark"/> <script src="/assets/js/theme.js"></script> <script src="/assets/js/dark_mode.js"></script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/">devsong's website</a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">关于</a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">博客<span class="sr-only">(current)</span></a> </li> <li class="nav-item "> <a class="nav-link" href="/repositories/">github</a> </li> <li class="nav-item "> <a class="nav-link" href="/cv/">个人简介</a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="fas fa-moon"></i> <i class="fas fa-sun"></i> </button> </li> </ul> </div> </div> </nav> </header> <div class="container mt-5"> <div class="post"> <header class="post-header"> <h1 class="post-title">散列算法与布隆过滤器</h1> <p class="post-meta">March 30, 2022</p> <p class="post-tags"> <a href="/blog/2022"> <i class="fas fa-calendar fa-sm"></i> 2022 </a>   ·   <a href="/blog/tag/blogs"> <i class="fas fa-hashtag fa-sm"></i> blogs</a>   <a href="/blog/tag/java"> <i class="fas fa-hashtag fa-sm"></i> java</a>   <a href="/blog/tag/string"> <i class="fas fa-hashtag fa-sm"></i> string</a>   <a href="/blog/tag/hashcode"> <i class="fas fa-hashtag fa-sm"></i> hashCode</a>   <a href="/blog/tag/bloomfilter"> <i class="fas fa-hashtag fa-sm"></i> bloomfilter</a>     ·   <a href="/blog/category/blogs"> <i class="fas fa-tag fa-sm"></i> blogs</a>   </p> </header> <article class="post-content"> <h3 id="散列算法与布隆过滤器">散列算法与布隆过滤器</h3> <p>在<a href="/blog/2022/03/002-Object%E4%BB%A5%E5%8F%8AHashCode%E7%AE%80%E4%BB%8B/">Java Object以及HashCode简介中提到过Hash算法</a>一文中对散列有一个初步的认识，一句话总结散列算法</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
</pre></td> <td class="rouge-code"><pre>对于任意输入长度的数据，经过Hash运算，使之能映射到指定的地址空间,后续针对此数据的查找演变为针对此特征值的查找过程
</pre></td> </tr></tbody></table></code></pre></div></div> <p>互联网下载文件常用的文件校验码是另一类Hash算法的典型应用,用于验证数据的完整性,来看一下apache tomcat的下载页面</p> <p><img src="/assets/img/java/string/tomcat_download.png" width="760" height="500" alt="tomcat_download.png"></p> <p>可以看到上述标红的部分即为文件的特征码/散列码/Hash值,可以看到文件后缀为sha512，代表使用sha512算法进行的散列，对应的文件内容为</p> <div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
</pre></td> <td class="rouge-code"><pre>4889f416a2c7548d6a94386496a788c7e611b5250df2ab4bddd7f3fba0e6989751983cc0914d32780b8bfe90da98d6f29024c8d60f69c560b8e8295db396e25a *apache-tomcat-8.5.81-deployer.tar.gz
</pre></td> </tr></tbody></table></code></pre></div></div> <p>对应的链接地址<a href="https://downloads.apache.org/tomcat/tomcat-8/v8.5.81/bin/" target="_blank" rel="noopener noreferrer">tomcat 8.5.81</a></p> <p>下面简单介绍下互联网上几种散列算法</p> <ul> <li>MD5 知名的散列算法，输出长度固定为16字节(128bit)，出现时间较早，诞生于上个世纪90年代，由Ron Rivest（RSA公司）提出，使用广泛</li> <li>SHA1 与MD5同时代的算法，输出长度固定为20字节(160bit),由NSA提出</li> <li>SHA2 通常包含SHA224,SHA256,SHA384,SHA512 ,SHA1的升级版，数字代表散列值的输出长度，通常长度越长代表越安全</li> <li>SHA3 包含SHA3-224,SHA3-256,SHA3-384,SHA3-512,SHA的第三版，最新的标准</li> </ul> <p>MD5/SHA1均已被攻破，不在被推荐使用，目前SHA2/SHA3暂被认为是安全的，可以放心使用</p> <p>来看一下生活中的一个示例，下图演示法院在对被告作判决一个简短的示意图</p> <p><img src="/assets/img/java/string/court_example.png" alt="tomcat download" style="zoom:60%;"></p> <p>假定在对红色小人进行判罚的时候，三名证人基于自己了解的事件过程如实作答，基于此判定做出有罪/无罪判罚，在少数服从多数的情况下，假定认为投票数超过一半，那么法官便认为此人可以被定罪从而进行判罚(实际生活中的判罚过程比这个复杂的多的多)</p> <h3 id="bloom-filter">Bloom Filter</h3> <p>上文介绍道散列算法可以对数据做完整形校验,散列值可以近似看作是数据的签名，它们一一对应，但是通常情况下数据是无限的，而签名是经过散列算法运算得到的固定输出的值，理论上来说他的地址空间有限，有限在理论上意味着有可能两个不一样的数据存在重复的可能，同样的在互联网的世界中，集群(实例数&gt;=2)系统提供服务的可靠性(可用性)通常是远远大于单实例，在系统架构允许的情况下,可以选择增加集群中实例的数量，来达到提升系统可用性这一指标数据</p> <p>Bloom Filter过滤器实质上是一个bit向量或者一个bit数组,通常情况下它长这样:</p> <p><img src="/assets/img/java/string/bloom_slot.png" alt="bloom_filter" style="zoom:150%;"></p> <p>bit 位为0代表数据不存在,bit 位为1 代表有数据，来看两个简单的数据写入示例:</p> <p><img src="/assets/img/java/string/bloom_geeks.png" alt="bloom_geeks.png" style="zoom:150%;"></p> <ul> <li>“geeks” 进过<code class="language-plaintext highlighter-rouge">hash1("geeks")</code>/<code class="language-plaintext highlighter-rouge">hash2("geeks")</code>/<code class="language-plaintext highlighter-rouge">hash3("geeks")</code> 运算后，生成三个散列值</li> <li>将上述三个散列值分别与数组做取模运算,填充数组下标的值(将指定下标位置置为1)</li> </ul> <p><img src="/assets/img/java/string/bloom_nerd.png" alt="bloom_nerd.png" style="zoom:150%;"></p> <p>字符串”nerd”的写入过程同上述”geeks”，此处不在赘述</p> <p>查询阶段，针对”geeks”，按照<code class="language-plaintext highlighter-rouge">hash1("geeks")</code>/<code class="language-plaintext highlighter-rouge">hash2("geeks")</code>/<code class="language-plaintext highlighter-rouge">hash3("geeks")</code> 计算后的值与数组长度做取模运算,三个bit都返回1，我们认为”geeks”在bloom filter中<strong>存在,</strong>针对字符串”foobar”,经过<code class="language-plaintext highlighter-rouge">hash1("geeks")</code>/<code class="language-plaintext highlighter-rouge">hash2("geeks")</code>/<code class="language-plaintext highlighter-rouge">hash3("geeks")</code>运算后，假定返回上图中2/5/7这三个值，我们知道2这个位置为0，因此我们可以认为”foobar”字符串<strong>不存在</strong>bloom filter中，针对上述过程，我们可以发现</p> <ul> <li>Bloom Filter需要多个散列函数参与数据集的散列运算</li> <li>Bloom Filter不支持删除(通常意义上Bloom Filter底层数组数据可提前生成，有支持删除的Bloom Filter变种，大家可自行google之)</li> <li>Bloom Filter的向量/数字索引位只能保存2个值,通常代表两个状态</li> <li>由于散列算法天然的特性(无限数据集-&gt;有限地址空间之间的映射)，散列冲突不可避免,因此Bloom Filter的得出数据的存在是一种<strong>假想</strong>意义上的存在,存在一定的误报率，只不过误报率通常情况下较低</li> <li>Bloom Filter返回的不存在代表数据一定不存在</li> <li>Bloom Filter的大小与输入的数据集长度无关</li> </ul> <p>结合上述四点，可以看到Bloom Filter应用的场景非常适合于下述代码场景</p> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td> <td class="rouge-code"><pre><span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">exist</span><span class="o">(</span><span class="kt">byte</span><span class="o">[]</span> <span class="n">res</span><span class="o">){</span>
	<span class="nc">String</span> <span class="n">hash1</span> <span class="o">=</span> <span class="n">hashAlg1</span><span class="o">(</span><span class="n">res</span><span class="o">);</span>
	<span class="nc">String</span> <span class="n">hash2</span> <span class="o">=</span> <span class="n">hashAlg2</span><span class="o">(</span><span class="n">res</span><span class="o">);</span>
	<span class="nc">String</span> <span class="n">hash3</span> <span class="o">=</span> <span class="n">hashAlg3</span><span class="o">(</span><span class="n">res</span><span class="o">);</span>
	<span class="k">if</span><span class="o">(</span><span class="nc">BloomFilter</span><span class="o">.</span><span class="na">notExists</span><span class="o">(</span><span class="n">hash1</span><span class="o">,</span><span class="n">hash2</span><span class="o">,</span><span class="n">hash3</span><span class="o">)){</span>
		<span class="c1">// res</span>
		<span class="k">return</span> <span class="nf">sendBackResNotExist</span><span class="o">();</span>
	<span class="o">}</span><span class="k">else</span><span class="o">{</span>
		<span class="c1">// more action to confirm res exists in business system</span>
		<span class="k">if</span><span class="o">(</span><span class="n">doMoreActionToConfirm</span><span class="o">(</span><span class="n">res</span><span class="o">)){</span>
			<span class="n">addResToBloomFilter</span><span class="o">(</span><span class="n">res</span><span class="o">);</span>
			<span class="k">return</span> <span class="nf">sendBackResExist</span><span class="o">();</span>
		<span class="o">}</span><span class="k">else</span><span class="o">{</span>
			<span class="k">return</span> <span class="nf">sendBackResNotExist</span><span class="o">();</span>
		<span class="o">}</span>
	<span class="o">}</span>
<span class="o">}</span>
</pre></td> </tr></tbody></table></code></pre></div></div> <p>Bloom Filter被大量应用于web 搜索引擎/反垃圾邮件过滤/缓存穿透等等应用场景，来看一个web 搜索引擎的示例</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
</pre></td> <td class="rouge-code"><pre>互联网的web url链接的规模通常情况下都数以亿计,假定一家新型的搜索引擎公司需要用爬虫爬取整个互联网的url内容并进行索引，初步假定要爬取的url的数量为100亿条，对于爬虫程序而言，为了降低无谓的工作量,已经被其他爬虫爬取过的页面内容，在近3天时间内无需再次抓取。
</pre></td> </tr></tbody></table></code></pre></div></div> <p>上述需求有三个关键点</p> <ul> <li>数据量级较大(100亿),意味着传统的数据库存储方式已经不再适合</li> <li>数据有效期为3天，三天后，为了保证数据的实时性，需要对已经抓取过的URL链接进行重新的抓取</li> <li>每个URL仅需被抓取一次</li> </ul> <p>针对上述三个场景的需要从如下几个方面入手思考</p> <ul> <li> <p>针对场景1 ，假定Bloom Filter 散列函数为三个,那么需要生成的散列值的个数为<code class="language-plaintext highlighter-rouge">3x100x10^9</code>,占用的存储空间大小为<code class="language-plaintext highlighter-rouge">3x100x10^8/(1024*1024*1024*8)</code>，简约计算<code class="language-plaintext highlighter-rouge">3x10x10^9/(10^9*8)</code>,约等于3.75GB的存储空间</p> </li> <li> <p>针对场景2，Bloom Filter通常基于内存，3.75GB内存对于现今的服务器内存动不动上百G来讲，相当于九牛一毛，单台服务的内存就能存下如此多的数据，而且内存具有易失性的特性，借助于现今的各种缓存服务器，针对场景二也能很容易满足</p> </li> <li> <p>针对场景三，结合上述关于Bloom Filter的介绍以及Bloom Filter的应用场景，不难看出场景三也很容易满足</p> </li> </ul> <h3 id="bloom-filter误判率">Bloom Filter误判率</h3> <p>前文提到Bloom Filter对于已经存在的数据，Bloom Filter得出的结果是可能存在，实际上大家通过上述的介绍可以知道,只要散列冲突的概率越小,数组向量的长度越大,最终bit数组中产生的重复数据越小，亦即产生的误判率越低，以下几个方面可以降低Bloom Filter的误判率</p> <ul> <li>散列冲突的概率可以选择合适的散列函数(算法)来优化数据的散列冲突</li> <li>数组向量的绝对长度越大(空间越大),整个Bloom Filter被填满的速度越慢，产生的误判率亦即越低</li> </ul> <p>实际应用上，散列算法的优化/可选择的散列函数均有一大票论文，而且对于技术的要求通常是比较高的，而数组的向量的绝对长度通常是比较好优化的一个手段/方向，基于业务体量,设计良好的分布式Bloom Filter可以支持横向扩展</p> </article> </div> <style>table{border-left:1px solid #000;border-top:1px solid #000;width:100%;word-wrap:break-word;word-break:break-all}table th{text-align:left;min-width:60px;max-width:300px}table th,td{border-right:1px solid #000;border-bottom:1px solid #000}</style> </div> <footer class="fixed-bottom"> <div class="container mt-0"> © Copyright 2023 guan zhisong. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="noopener noreferrer">Jekyll</a> with <a href="https://github.com/devsong/devsong.github.io" target="_blank" rel="noopener noreferrer">devsong.github.io</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="noopener noreferrer">GitHub Pages</a>. Photos from <a href="https://unsplash.com" target="_blank" rel="noopener noreferrer">Unsplash</a>. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js" integrity="sha256-fgLAgv7fyCGopR/gBNq2iW3ZKIdqIcyshnUULC4vex8=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script type="text/javascript">$(function(){$('[data-toggle="tooltip"]').tooltip()});</script> <script defer src="/assets/js/common.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> </body> </html>